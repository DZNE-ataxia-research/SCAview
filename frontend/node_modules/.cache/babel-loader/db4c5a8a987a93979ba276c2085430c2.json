{"ast":null,"code":"import _defineProperty from\"/idsn/git/July_22/PostIDSN-Viewer/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _toConsumableArray from\"/idsn/git/July_22/PostIDSN-Viewer/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"/idsn/git/July_22/PostIDSN-Viewer/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"/idsn/git/July_22/PostIDSN-Viewer/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect}from'react';import Grid from'../components/Grid';import Plot from'../components/Plot';import localStorage from'../services/LocalStorage';import backend,{Fit,Legend}from'../services/Backend';import utilities from'../services/Utilities';import Filter,{defaultConcept}from'./Filter';import Configuration,{DiagramType,initialDiagramType,Visit}from'./Controls';import Button from'@material-ui/core/Button';import Card from'@material-ui/core/Card';import CardContent from'@material-ui/core/CardContent';import IconButton from'@material-ui/core/IconButton';import LinearProgress from'@material-ui/core/LinearProgress';import'./Viewer.css';import AddIcon from'@material-ui/icons/Add';import AspectRatioIcon from'@material-ui/icons/AspectRatio';import ReplayIcon from'@material-ui/icons/Replay';import SettingsIcon from'@material-ui/icons/Settings';import FilterListIcon from'@material-ui/icons/FilterList';import EditIcon from'@material-ui/icons/Edit';import CloseIcon from'@material-ui/icons/Close';import Alert from'@material-ui/lab/Alert';import Snackbar from'@material-ui/core/Snackbar';// CONFIG\nexport var initialControls={identifier:'',type:initialDiagramType,attX:'',attY:'',attC:'',dt:0,visit:Visit.all,followup:0,tolerance:0,norm:false,stack:false,fit:Fit.none,legend:Legend.legend,bins:0};// PROPS\nvar Viewer=function Viewer(props){var _localStorage$getObje,_localStorage$getObje2,_localStorage$getObje3,_localStorage$getObje4,_localStorage$getObje5,_localStorage$getObje6,_plotControlsState$vi;// GET ATTRIBUTES METHODS\nvar _useState=useState([]),_useState2=_slicedToArray(_useState,2),attributes=_useState2[0],setAttributes=_useState2[1];// PATIENTS and SUBGROUPS are added to attributes manually and have this values as datatype\nvar getTooltip=function getTooltip(attribute_){return attributes?attributes.filter(function(attr){return attr[\"attribute\"]===attribute_;})[0][\"attributeTooltip\"]:\"\";};var filter=function filter(datatypes){return attributes.filter(function(attribute){return Object.values(datatypes).findIndex(function(datatype){return attribute.datatype===datatype;})!==-1;});};// STATES\n// errorState\nvar _useState3=useState(),_useState4=_slicedToArray(_useState3,2),errorState=_useState4[0],setErrorState=_useState4[1];var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),errorText=_useState6[0],setErrorText=_useState6[1];//\n//const [loadingAttributes, setLoadingAttributes] = useState();\nuseEffect(function(){backend.getAttributes().then(function(response){console.log(response);setAttributes(response.data.allAttributes);});},[]);// viewerState\nvar initialViewerState={controlsVisible:false,filtersVisible:true,activePlot:''};var _useState7=useState(initialViewerState),_useState8=_slicedToArray(_useState7,2),viewerState=_useState8[0],setViewerState=_useState8[1];var _useState9=useState((_localStorage$getObje=localStorage.getObjectItem('grid.layouts'))!==null&&_localStorage$getObje!==void 0?_localStorage$getObje:{}),_useState10=_slicedToArray(_useState9,2),gridLayoutsState=_useState10[0],setGridLayoutsState=_useState10[1];useEffect(function(){localStorage.setObjectItem('grid.layouts',gridLayoutsState);forceResize();},[gridLayoutsState,viewerState]);// gridLayoutsState\nuseEffect(function(){localStorage.setObjectItem('grid.layouts',gridLayoutsState);forceResize();},[gridLayoutsState]);// gridItemsState\nvar _useState11=useState(((_localStorage$getObje2=localStorage.getObjectItem('grid.items'))!==null&&_localStorage$getObje2!==void 0?_localStorage$getObje2:[]).// Workaround for bug in layout serialization - Infinity (and possibly others) gets saved as null\nmap(function(item){var _item$y;return _objectSpread(_objectSpread({},item),{},{y:(_item$y=item.y)!==null&&_item$y!==void 0?_item$y:Infinity});})),_useState12=_slicedToArray(_useState11,2),gridItemsState=_useState12[0],setGridItemsState=_useState12[1];useEffect(function(){localStorage.setObjectItem('grid.items',gridItemsState);},[gridItemsState]);// gridResponsiveState\nvar initialResponsiveState={breakpoint:'',cols:12};var _useState13=useState(initialResponsiveState),_useState14=_slicedToArray(_useState13,2),gridResponsiveState=_useState14[0],setGridResponsiveState=_useState14[1];useEffect(function(){forceResize();},[gridResponsiveState]);// filterState\nvar defaultFilterState={concept:defaultConcept,constraints:[]};var _useState15=useState((_localStorage$getObje3=localStorage.getObjectItem('filter'))!==null&&_localStorage$getObje3!==void 0?_localStorage$getObje3:defaultFilterState),_useState16=_slicedToArray(_useState15,2),filterState=_useState16[0],setFilterState=_useState16[1];useEffect(function(){localStorage.setObjectItem('filter',filterState);},[filterState]);// subgroupsState\nvar _useState17=useState((_localStorage$getObje4=localStorage.getObjectItem('subgroups'))!==null&&_localStorage$getObje4!==void 0?_localStorage$getObje4:[]),_useState18=_slicedToArray(_useState17,2),subgroupsState=_useState18[0],setSubgroupsState=_useState18[1];useEffect(function(){localStorage.setObjectItem('subgroups',subgroupsState);},[subgroupsState]);// plotControlsState\nvar _useState19=useState((_localStorage$getObje5=localStorage.getObjectItem('controls'))!==null&&_localStorage$getObje5!==void 0?_localStorage$getObje5:{}),_useState20=_slicedToArray(_useState19,2),plotControlsState=_useState20[0],setPlotControlsState=_useState20[1];useEffect(function(){localStorage.setObjectItem('controls',plotControlsState);},[plotControlsState]);// plotsState\nvar _useState21=useState((_localStorage$getObje6=localStorage.getObjectItem('plots'))!==null&&_localStorage$getObje6!==void 0?_localStorage$getObje6:{}),_useState22=_slicedToArray(_useState21,2),plotsState=_useState22[0],setPlotsState=_useState22[1];useEffect(function(){localStorage.setObjectItem('plots',plotsState);},[plotsState]);// updatingState\nvar _useState23=useState({}),_useState24=_slicedToArray(_useState23,2),updatingState=_useState24[0],setUpdatingState=_useState24[1];// HANDLERS\nvar onGridBreakpointChange=function onGridBreakpointChange(breakpoint,cols){setGridResponsiveState({breakpoint:breakpoint,cols:cols});};var onViewerConfigurationToggle=function onViewerConfigurationToggle(){setViewerState(_objectSpread(_objectSpread({},viewerState),{},{controlsVisible:!viewerState.controlsVisible}));};var onViewerFilterToggle=function onViewerFilterToggle(){setViewerState(_objectSpread(_objectSpread({},viewerState),{},{filtersVisible:!viewerState.filtersVisible}));};var onGridLayoutChange=function onGridLayoutChange(layout,layouts){setGridLayoutsState(layouts);};var onGridItemAdd=function onGridItemAdd(){var identifier=utilities.generateIdentifier();var newIdentifiers=[].concat(_toConsumableArray(Object.keys(plotsState)),[identifier]);backend.sessionInit(newIdentifiers).then(function(){var _document$querySelect,_document$querySelect2;setGridItemsState([].concat(_toConsumableArray(gridItemsState),[createGridItem(identifier)]));setPlotControlsState(_objectSpread(_objectSpread({},plotControlsState),_defineProperty({},identifier,createInitialPlotControlsState(identifier))));setPlotsState(_objectSpread(_objectSpread({},plotsState),_defineProperty({},identifier,{data:[],layout:{}})));setViewerState(_objectSpread(_objectSpread({},viewerState),{},{activePlot:identifier,controlsVisible:true}));(_document$querySelect=document.querySelector(\".scrollContainer\"))===null||_document$querySelect===void 0?void 0:_document$querySelect.scrollTo({top:(_document$querySelect2=document.querySelector(\".scrollContainer\"))===null||_document$querySelect2===void 0?void 0:_document$querySelect2.scrollHeight,behavior:'smooth'});}).catch(handleError);};var onGridItemRemove=function onGridItemRemove(identifier){var newPlotsState=_objectSpread({},plotsState);delete newPlotsState[identifier];backend.sessionInit(Object.keys(newPlotsState)).then(function(){setGridItemsState(gridItemsState.filter(function(item){return item.i!==identifier;}));setPlotsState(newPlotsState);var newPlotControlsState=_objectSpread({},plotControlsState);delete newPlotControlsState[identifier];setPlotControlsState(newPlotControlsState);if(viewerState.activePlot===identifier){setViewerState(_objectSpread(_objectSpread({},viewerState),{},{activePlot:'',controlsVisible:false}));}}).catch(handleError);};var onGridItemEdit=function onGridItemEdit(identifier){setViewerState(_objectSpread(_objectSpread({},viewerState),{},{activePlot:identifier,controlsVisible:true}));};var onReset=function onReset(){backend.sessionReset().then(function(){setViewerState(initialViewerState);setGridResponsiveState(initialResponsiveState);localStorage.setObjectItem('grid.layouts',{});setGridLayoutsState({});localStorage.setObjectItem('grid.items',[]);setGridItemsState([]);localStorage.setObjectItem('filter',defaultFilterState);setFilterState(defaultFilterState);localStorage.setObjectItem('controls',{});setPlotControlsState({});localStorage.setObjectItem('plots',{});setPlotsState({});localStorage.setObjectItem('subgroups',[]);setSubgroupsState([]);}).catch(handleError);};var onPlotSelected=function onPlotSelected(identifier,range,items){if(!range){return;}setUpdating();var newFilterState=_objectSpread(_objectSpread({},filterState),{},{constraints:_toConsumableArray(filterState.constraints)});// Update/add x-constraint\nif([DiagramType.Scatter,DiagramType.Histogram,DiagramType.Timeline].includes(plotControlsState[identifier].controls.type)){var newXConstraint={attribute:plotControlsState[identifier].controls.attX,lower:range.x[0],upper:range.x[1],items:[]};var constraintXIndex=newFilterState.constraints.findIndex(function(constraint){return constraint.attribute===plotControlsState[identifier].controls.attX;});if(constraintXIndex>-1){newFilterState.constraints[constraintXIndex]=newXConstraint;}else{newFilterState.constraints.push(newXConstraint);}}// Update/add y-constraint\nif([DiagramType.Scatter,DiagramType.Timeline].includes(plotControlsState[identifier].controls.type)){var newYConstraint={attribute:plotControlsState[identifier].controls.attY,lower:range.y[0],upper:range.y[1],items:[]};var constraintYIndex=newFilterState.constraints.findIndex(function(constraint){return constraint.attribute===plotControlsState[identifier].controls.attY;});if(constraintYIndex>-1){newFilterState.constraints[constraintYIndex]=newYConstraint;}else{newFilterState.constraints.push(newYConstraint);}}// Update/add discrete constraint\nif([DiagramType.Bar].includes(plotControlsState[identifier].controls.type)){var _newXConstraint={attribute:plotControlsState[identifier].controls.attX,lower:null,upper:null,items:items};var _constraintXIndex=newFilterState.constraints.findIndex(function(constraint){return constraint.attribute===plotControlsState[identifier].controls.attX;});if(_constraintXIndex>-1){newFilterState.constraints[_constraintXIndex]=_newXConstraint;}else{newFilterState.constraints.push(_newXConstraint);}}setFilterState(newFilterState);utilities.devLog('new filters:',newFilterState);backend.filterUpdate(newFilterState).then(function(figures){handleFilterUpdateResponse(figures);}).catch(handleError);};var onFilterChanged=function onFilterChanged(filters){setUpdating();var newFilterState=_objectSpread(_objectSpread({},filterState),filters);setFilterState(newFilterState);utilities.devLog('new filters:',newFilterState);backend.filterUpdate(newFilterState).then(function(figures){handleFilterUpdateResponse(figures);}).catch(handleError);};var onSubgroupDefine=function onSubgroupDefine(subgroup){backend.subgroupDefine(subgroup.name).then(function(){setSubgroupsState([].concat(_toConsumableArray(subgroupsState.filter(function(_subgroup){return _subgroup.name!==subgroup.name;})),[subgroup]));}).catch(handleError);};var onSubgroupDelete=function onSubgroupDelete(name){//alert('Not yet implemented in backend.');\nbackend.subgroupDelete(name).then(function(response){setSubgroupsState(_toConsumableArray(subgroupsState.filter(function(subgroup){return subgroup.name!==name;})));});};var onSubgroupActivate=function onSubgroupActivate(name){var subgroup=subgroupsState.find(function(subgroup){return subgroup.name===name;});//console.log(subgroup);\nonFilterChanged(_objectSpread(_objectSpread({},filterState),{},{constraints:subgroup===null||subgroup===void 0?void 0:subgroup.constraints}));};var onControlsChanged=function onControlsChanged(identifier,controls){setUpdating(identifier);var newControls=_objectSpread(_objectSpread({},plotControlsState[identifier].controls),controls);var newPlotControls=_objectSpread(_objectSpread({},plotControlsState),_defineProperty({},identifier,_objectSpread(_objectSpread({},plotsState[identifier]),{},{controls:newControls})));//console.log()\nsetPlotControlsState(newPlotControls);utilities.devLog('new controls:',newControls);backend.controlsUpdate(newPlotControls[identifier].controls).then(function(figure){handleControlsUpdateResponse(identifier,figure);}).catch(handleError);};// HELPER (see first part above)\nvar handleError=function handleError(error){console.log(error);try{setErrorText(\"\".concat(error.toJSON().name,\": \").concat(error.toJSON().message));}catch(e){setErrorText('ERROR: unknown');}setErrorState(true);var newState={};Object.keys(plotControlsState).forEach(function(identifier){newState[identifier]=false;});setUpdatingState(newState);};var handleControlsUpdateResponse=function handleControlsUpdateResponse(identifier,figure){setPlotsState(_objectSpread(_objectSpread({},plotsState),{},_defineProperty({},identifier,_objectSpread(_objectSpread({},plotsState[identifier]),{},{data:figure.data||[],layout:figure.layout||{}}))));utilities.devLog(identifier,'done');setUpdatingState(_objectSpread(_objectSpread({},updatingState),{},_defineProperty({},identifier,false)));};var handleFilterUpdateResponse=function handleFilterUpdateResponse(figures){var identifiers=Object.keys(figures);var newPlotsState=_objectSpread({},plotsState);var newUpdatingState=_objectSpread({},updatingState);identifiers.forEach(function(identifier){newPlotsState[identifier]={data:figures[identifier].data||[],layout:figures[identifier].layout||{}};newUpdatingState[identifier]=false;});setPlotsState(newPlotsState);setUpdatingState(newUpdatingState);};var forceResize=function forceResize(){// Workaround to trigger plot resize\nwindow.dispatchEvent(new Event('resize'));};var createGridItem=function createGridItem(identifier){return{i:identifier,x:gridItemsState.length*5%gridResponsiveState.cols,y:Infinity,w:5,h:4};};var createInitialPlotControlsState=function createInitialPlotControlsState(identifier){return{controls:_objectSpread(_objectSpread({},initialControls),{},{identifier:identifier})};};var setUpdating=function setUpdating(identifier){if(identifier){setUpdatingState(_objectSpread(_objectSpread({},updatingState),{},_defineProperty({},identifier,true)));}else{var newState={};Object.keys(plotControlsState).forEach(function(identifier){newState[identifier]=true;});setUpdatingState(newState);}};// RENDER\nvar createGridItemElement=function createGridItemElement(item){var _plotsState$item$i,_plotsState$item$i2;return/*#__PURE__*/React.createElement(Card,{key:item.i,\"data-grid\":item,className:\"grid__item \".concat(viewerState.activePlot===item.i?' grid__item--active':''),onClick:function onClick(){onGridItemEdit(item.i);}},/*#__PURE__*/React.createElement(\"div\",{className:\"grid__item-header grid--draggable\"},/*#__PURE__*/React.createElement(IconButton,{size:\"small\",\"aria-label\":\"edit\"},/*#__PURE__*/React.createElement(EditIcon,null)),/*#__PURE__*/React.createElement(IconButton,{size:\"small\",\"aria-label\":\"close\",onClick:function onClick(){onGridItemRemove(item.i);},className:\"grid__item--close\"},/*#__PURE__*/React.createElement(CloseIcon,null))),/*#__PURE__*/React.createElement(\"div\",{className:\"grid__item-loader\"},updatingState[item.i]&&/*#__PURE__*/React.createElement(LinearProgress,null)),/*#__PURE__*/React.createElement(CardContent,{className:\"grid__item-content\"},/*#__PURE__*/React.createElement(Plot,{identifier:item.i,data:(_plotsState$item$i=plotsState[item.i])===null||_plotsState$item$i===void 0?void 0:_plotsState$item$i.data,layout:(_plotsState$item$i2=plotsState[item.i])===null||_plotsState$item$i2===void 0?void 0:_plotsState$item$i2.layout,onSelected:onPlotSelected})));};if(!(attributes&&attributes.length))return null;return/*#__PURE__*/React.createElement(\"div\",{className:\"container\"},/*#__PURE__*/React.createElement(\"div\",{className:\"toolbar\"},/*#__PURE__*/React.createElement(\"div\",{className:\"toolbar__left\"},/*#__PURE__*/React.createElement(Button,{onClick:onGridItemAdd,variant:\"contained\",color:\"primary\",startIcon:/*#__PURE__*/React.createElement(AddIcon,null),title:\"Add new diagram\"},\"Add\"),/*#__PURE__*/React.createElement(Button,{onClick:forceResize,variant:\"contained\",color:\"primary\",startIcon:/*#__PURE__*/React.createElement(AspectRatioIcon,null),title:\"Force resize\"},\"Resize\"),/*#__PURE__*/React.createElement(Button,{onClick:onReset,variant:\"contained\",color:\"primary\",startIcon:/*#__PURE__*/React.createElement(ReplayIcon,null),title:\"Reset session\"},\"Reset session\")),/*#__PURE__*/React.createElement(\"div\",{className:\"toolbar__right\"},/*#__PURE__*/React.createElement(Button,{onClick:onViewerConfigurationToggle,variant:\"contained\",color:\"primary\",startIcon:/*#__PURE__*/React.createElement(SettingsIcon,null),title:\"Toggle configuration panel\"},\"Configuration\"),/*#__PURE__*/React.createElement(Button,{onClick:onViewerFilterToggle,variant:\"contained\",color:\"primary\",startIcon:/*#__PURE__*/React.createElement(FilterListIcon,null),title:\"Toggle filter panel\"},\"Filter\"))),/*#__PURE__*/React.createElement(\"div\",{className:\"row\"},viewerState.filtersVisible&&/*#__PURE__*/React.createElement(Filter,{filter:filterState,subgroups:subgroupsState,onFilterChanged:onFilterChanged,onSubgroupDefine:onSubgroupDefine,onSubgroupDelete:onSubgroupDelete,onSubgroupActivate:onSubgroupActivate,onClose:onViewerFilterToggle,getTooltip:getTooltip}),/*#__PURE__*/React.createElement(\"div\",{className:\"scrollContainer\"},/*#__PURE__*/React.createElement(Grid,{breakpointCols:{lg:12,md:10,sm:6,xs:4,xxs:2},rowHeight:100,layouts:gridLayoutsState,onBreakpointChange:onGridBreakpointChange,onLayoutChange:onGridLayoutChange},gridItemsState.map(function(item){return createGridItemElement(item);}))),viewerState.controlsVisible&&/*#__PURE__*/React.createElement(Configuration,{controls:(_plotControlsState$vi=plotControlsState[viewerState.activePlot])===null||_plotControlsState$vi===void 0?void 0:_plotControlsState$vi.controls,onControlsChanged:onControlsChanged,onClose:onViewerConfigurationToggle,filter:filter})),/*#__PURE__*/React.createElement(Snackbar,{open:errorState,autoHideDuration:10000,onClose:function onClose(){setErrorState(false);},anchorOrigin:{vertical:'top',horizontal:'right'}},/*#__PURE__*/React.createElement(Alert,{variant:\"filled\",severity:\"error\",onClose:function onClose(){setErrorState(false);}},errorText)));};export default Viewer;","map":{"version":3,"sources":["/idsn/git/July_22/PostIDSN-Viewer/src/containers/Viewer.tsx"],"names":["React","useState","useEffect","Grid","Plot","localStorage","backend","Fit","Legend","utilities","Filter","defaultConcept","Configuration","DiagramType","initialDiagramType","Visit","Button","Card","CardContent","IconButton","LinearProgress","AddIcon","AspectRatioIcon","ReplayIcon","SettingsIcon","FilterListIcon","EditIcon","CloseIcon","Alert","Snackbar","initialControls","identifier","type","attX","attY","attC","dt","visit","all","followup","tolerance","norm","stack","fit","none","legend","bins","Viewer","props","attributes","setAttributes","getTooltip","attribute_","filter","attr","datatypes","attribute","Object","values","findIndex","datatype","errorState","setErrorState","errorText","setErrorText","getAttributes","then","response","console","log","data","allAttributes","initialViewerState","controlsVisible","filtersVisible","activePlot","viewerState","setViewerState","getObjectItem","gridLayoutsState","setGridLayoutsState","setObjectItem","forceResize","map","item","y","Infinity","gridItemsState","setGridItemsState","initialResponsiveState","breakpoint","cols","gridResponsiveState","setGridResponsiveState","defaultFilterState","concept","constraints","filterState","setFilterState","subgroupsState","setSubgroupsState","plotControlsState","setPlotControlsState","plotsState","setPlotsState","updatingState","setUpdatingState","onGridBreakpointChange","onViewerConfigurationToggle","onViewerFilterToggle","onGridLayoutChange","layout","layouts","onGridItemAdd","generateIdentifier","newIdentifiers","keys","sessionInit","createGridItem","createInitialPlotControlsState","document","querySelector","scrollTo","top","scrollHeight","behavior","catch","handleError","onGridItemRemove","newPlotsState","i","newPlotControlsState","onGridItemEdit","onReset","sessionReset","onPlotSelected","range","items","setUpdating","newFilterState","Scatter","Histogram","Timeline","includes","controls","newXConstraint","lower","x","upper","constraintXIndex","constraint","push","newYConstraint","constraintYIndex","Bar","devLog","filterUpdate","figures","handleFilterUpdateResponse","onFilterChanged","filters","onSubgroupDefine","subgroup","subgroupDefine","name","_subgroup","onSubgroupDelete","subgroupDelete","onSubgroupActivate","find","onControlsChanged","newControls","newPlotControls","controlsUpdate","figure","handleControlsUpdateResponse","error","toJSON","message","e","newState","forEach","identifiers","newUpdatingState","window","dispatchEvent","Event","length","w","h","createGridItemElement","lg","md","sm","xs","xxs","vertical","horizontal"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from 'react';\nimport Grid from '../components/Grid';\nimport Plot from '../components/Plot';\nimport localStorage from '../services/LocalStorage';\nimport backend, { Fit, Legend } from '../services/Backend';\nimport utilities from '../services/Utilities';\nimport Filter, { FilterState, defaultConcept, Subgroup } from './Filter';\nimport Configuration, {\n  ControlsState,\n  DiagramType,\n  initialDiagramType,\n  Visit,\n  Datatype, Attribute\n} from './Controls';\nimport { Figure } from 'react-plotly.js';\nimport { Datum } from 'plotly.js';\nimport Button from '@material-ui/core/Button';\nimport Card from '@material-ui/core/Card';\nimport CardContent from '@material-ui/core/CardContent';\nimport IconButton from '@material-ui/core/IconButton';\nimport LinearProgress from '@material-ui/core/LinearProgress';\nimport './Viewer.css';\nimport AddIcon from '@material-ui/icons/Add';\nimport AspectRatioIcon from '@material-ui/icons/AspectRatio';\nimport ReplayIcon from '@material-ui/icons/Replay';\nimport SettingsIcon from '@material-ui/icons/Settings';\nimport FilterListIcon from '@material-ui/icons/FilterList';\nimport EditIcon from '@material-ui/icons/Edit';\nimport CloseIcon from '@material-ui/icons/Close';\nimport Alert from '@material-ui/lab/Alert';\nimport Snackbar from '@material-ui/core/Snackbar';\n\n\n// CONFIG\n\nexport const initialControls = {\n  identifier: '',\n  type: initialDiagramType,\n  attX: '',\n  attY: '',\n  attC: '',\n  dt: 0,\n  visit: Visit.all,\n  followup: 0,\n  tolerance: 0,\n  norm: false,\n  stack: false,\n  fit: Fit.none,\n  legend: Legend.legend,\n  bins: 0,\n};\n\n// PROPS\n\ninterface Props {}\n\n\n\n\n\nconst Viewer: React.FunctionComponent<Props> = props => {\n  // GET ATTRIBUTES METHODS\n\n  \n \n\n  const [attributes, setAttributes] = useState<Attribute[]>([]);\n  // PATIENTS and SUBGROUPS are added to attributes manually and have this values as datatype\n  \n  \n  const getTooltip = (attribute_: string): string => {\n      return attributes ? attributes.filter((attr: Attribute) => attr[\"attribute\"] === attribute_)[0][\"attributeTooltip\"] : \"\";\n  };\n  \n  const filter = (datatypes: Datatype[]): Attribute[] => {\n    return attributes.filter(\n      attribute =>\n        Object.values(datatypes).findIndex(\n          datatype => attribute.datatype === datatype,\n        ) !== -1,\n    );\n  };\n\n  // STATES\n\n  // errorState\n  const [errorState, setErrorState] = useState<boolean>();\n  const [errorText, setErrorText] = useState<string>('');\n\n  //\n\n\n  //const [loadingAttributes, setLoadingAttributes] = useState();\n\n  useEffect(()=>{\n    backend.getAttributes().then((response) =>{\n      console.log(response);\n      setAttributes(response.data.allAttributes);\n    });\n  }, []);\n\n  // viewerState\n  const initialViewerState = {\n    controlsVisible: false,\n    filtersVisible: true,\n    activePlot: '',\n  };\n  const [viewerState, setViewerState] =\n    useState<{\n      controlsVisible: boolean;\n      filtersVisible: boolean;\n      activePlot: string;\n    }>(initialViewerState);\n  const [gridLayoutsState, setGridLayoutsState] =\n    useState<ReactGridLayout.Layouts>(\n      localStorage.getObjectItem('grid.layouts') ?? {},\n    );\n\n  useEffect(() => {\n    localStorage.setObjectItem('grid.layouts', gridLayoutsState);\n    forceResize();\n  }, [gridLayoutsState, viewerState]);\n\n  // gridLayoutsState\n\n  useEffect(() => {\n    localStorage.setObjectItem('grid.layouts', gridLayoutsState);\n    forceResize();\n  }, [gridLayoutsState]);\n\n  // gridItemsState\n  const [gridItemsState, setGridItemsState] = useState<\n    ReactGridLayout.Layout[]\n  >(\n    (localStorage.getObjectItem('grid.items') ?? [])\n      // Workaround for bug in layout serialization - Infinity (and possibly others) gets saved as null\n      .map((item: ReactGridLayout.Layout) => {\n        return { ...item, y: item.y ?? Infinity };\n      }),\n  );\n  useEffect(() => {\n    localStorage.setObjectItem('grid.items', gridItemsState);\n  }, [gridItemsState]);\n\n  // gridResponsiveState\n  const initialResponsiveState = { breakpoint: '', cols: 12 };\n  const [gridResponsiveState, setGridResponsiveState] = useState<{\n    breakpoint: string;\n    cols: number;\n  }>(initialResponsiveState);\n  useEffect(() => {\n    forceResize();\n  }, [gridResponsiveState]);\n\n  // filterState\n  const defaultFilterState: FilterState = {\n    concept: defaultConcept,\n    constraints: [],\n  };\n\n  const [filterState, setFilterState] = useState<FilterState>(\n    localStorage.getObjectItem('filter') ?? defaultFilterState,\n  );\n  useEffect(() => {\n    localStorage.setObjectItem('filter', filterState);\n  }, [filterState]);\n\n  // subgroupsState\n  const [subgroupsState, setSubgroupsState] = useState<Subgroup[]>(\n    localStorage.getObjectItem('subgroups') ?? [],\n  );\n  useEffect(() => {\n    localStorage.setObjectItem('subgroups', subgroupsState);\n  }, [subgroupsState]);\n\n  // plotControlsState\n  interface PlotControlsState {\n    [key: string]: { controls: ControlsState };\n  }\n\n  const [plotControlsState, setPlotControlsState] = useState<PlotControlsState>(\n    localStorage.getObjectItem('controls') ?? {},\n  );\n  useEffect(() => {\n    localStorage.setObjectItem('controls', plotControlsState);\n  }, [plotControlsState]);\n\n  // plotsState\n  interface PlotState {\n    data: Plotly.Data[];\n    layout: Partial<Plotly.Layout>;\n  }\n  const [plotsState, setPlotsState] = useState<{ [key: string]: PlotState }>(\n    localStorage.getObjectItem('plots') ?? {},\n  );\n  useEffect(() => {\n    localStorage.setObjectItem('plots', plotsState);\n  }, [plotsState]);\n\n  // updatingState\n  interface UpdatingState {\n    [key: string]: boolean;\n  }\n  const [updatingState, setUpdatingState] = useState<UpdatingState>({});\n\n  // HANDLERS\n\n  const onGridBreakpointChange = (breakpoint: string, cols: number) => {\n    setGridResponsiveState({\n      breakpoint: breakpoint,\n      cols: cols,\n    });\n  };\n\n  const onViewerConfigurationToggle = () => {\n    setViewerState({\n      ...viewerState,\n      controlsVisible: !viewerState.controlsVisible,\n    });\n  };\n\n  const onViewerFilterToggle = () => {\n    setViewerState({\n      ...viewerState,\n      filtersVisible: !viewerState.filtersVisible,\n    });\n  };\n\n  const onGridLayoutChange = (\n    layout: ReactGridLayout.Layout[],\n    layouts: ReactGridLayout.Layouts,\n  ) => {\n    setGridLayoutsState(layouts);\n  };\n\n  const onGridItemAdd = () => {\n    const identifier = utilities.generateIdentifier();\n    const newIdentifiers = [...Object.keys(plotsState), identifier];\n    backend\n      .sessionInit(newIdentifiers)\n      .then(() => {\n        setGridItemsState([...gridItemsState, createGridItem(identifier)]);\n        setPlotControlsState({\n          ...plotControlsState,\n          ...{ [identifier]: createInitialPlotControlsState(identifier) },\n        });\n        setPlotsState({\n          ...plotsState,\n          ...{ [identifier]: { data: [], layout: {} } },\n        });\n        setViewerState({\n          ...viewerState,\n          activePlot: identifier,\n          controlsVisible: true,\n        });\n        document.querySelector(\".scrollContainer\")?.scrollTo({\n          top: document.querySelector(\".scrollContainer\")?.scrollHeight,\n          behavior: 'smooth'\n        });\n      })\n      .catch(handleError);\n  };\n\n  const onGridItemRemove = (identifier: string) => {\n    const newPlotsState = { ...plotsState };\n    delete newPlotsState[identifier];\n    backend\n      .sessionInit(Object.keys(newPlotsState))\n      .then(() => {\n        setGridItemsState(\n          gridItemsState.filter(\n            (item: ReactGridLayout.Layout) => item.i !== identifier,\n          ),\n        );\n        setPlotsState(newPlotsState);\n        const newPlotControlsState = { ...plotControlsState };\n        delete newPlotControlsState[identifier];\n        setPlotControlsState(newPlotControlsState);\n        if (viewerState.activePlot === identifier) {\n          setViewerState({\n            ...viewerState,\n            activePlot: '',\n            controlsVisible: false,\n          });\n        }\n      })\n      .catch(handleError);\n  };\n\n  const onGridItemEdit = (identifier: string) => {\n    setViewerState({\n      ...viewerState,\n      activePlot: identifier,\n      controlsVisible: true,\n    });\n  };\n\n  const onReset = () => {\n    backend\n      .sessionReset()\n      .then(() => {\n        setViewerState(initialViewerState);\n        setGridResponsiveState(initialResponsiveState);\n        localStorage.setObjectItem('grid.layouts', {});\n        setGridLayoutsState({});\n        localStorage.setObjectItem('grid.items', []);\n        setGridItemsState([]);\n        localStorage.setObjectItem('filter', defaultFilterState);\n        setFilterState(defaultFilterState);\n        localStorage.setObjectItem('controls', {});\n        setPlotControlsState({});\n        localStorage.setObjectItem('plots', {});\n        setPlotsState({});\n        localStorage.setObjectItem('subgroups', []);\n        setSubgroupsState([]);\n        \n      })\n      .catch(handleError);\n  };\n\n  const onPlotSelected = (\n    identifier: string,\n    range: Plotly.SelectionRange | undefined,\n    items: Datum[],\n  ) => {\n    if (!range) {\n      return;\n    }\n\n    setUpdating();\n    const newFilterState: FilterState = {\n      ...filterState,\n      constraints: [...filterState.constraints],\n    };\n    // Update/add x-constraint\n    if (\n      [\n        DiagramType.Scatter,\n        DiagramType.Histogram,\n        DiagramType.Timeline,\n      ].includes(plotControlsState[identifier].controls.type)\n    ) {\n      const newXConstraint = {\n        attribute: plotControlsState[identifier].controls.attX,\n        lower: range.x[0],\n        upper: range.x[1],\n        items: [],\n      };\n      const constraintXIndex = newFilterState.constraints.findIndex(\n        constraint =>\n          constraint.attribute === plotControlsState[identifier].controls.attX,\n      );\n      if (constraintXIndex > -1) {\n        newFilterState.constraints[constraintXIndex] = newXConstraint;\n      } else {\n        newFilterState.constraints.push(newXConstraint);\n      }\n    }\n    // Update/add y-constraint\n    if (\n      [DiagramType.Scatter, DiagramType.Timeline].includes(\n        plotControlsState[identifier].controls.type,\n      )\n    ) {\n      const newYConstraint = {\n        attribute: plotControlsState[identifier].controls.attY,\n        lower: range.y[0],\n        upper: range.y[1],\n        items: [],\n      };\n      const constraintYIndex = newFilterState.constraints.findIndex(\n        constraint =>\n          constraint.attribute === plotControlsState[identifier].controls.attY,\n      );\n      if (constraintYIndex > -1) {\n        newFilterState.constraints[constraintYIndex] = newYConstraint;\n      } else {\n        newFilterState.constraints.push(newYConstraint);\n      }\n    }\n    // Update/add discrete constraint\n    if (\n      [DiagramType.Bar].includes(plotControlsState[identifier].controls.type)\n    ) {\n      const newXConstraint = {\n        attribute: plotControlsState[identifier].controls.attX,\n        lower: null,\n        upper: null,\n        items: items,\n      };\n      const constraintXIndex = newFilterState.constraints.findIndex(\n        constraint =>\n          constraint.attribute === plotControlsState[identifier].controls.attX,\n      );\n      if (constraintXIndex > -1) {\n        newFilterState.constraints[constraintXIndex] = newXConstraint;\n      } else {\n        newFilterState.constraints.push(newXConstraint);\n      }\n    }\n\n    setFilterState(newFilterState);\n    utilities.devLog('new filters:', newFilterState);\n    backend\n      .filterUpdate(newFilterState)\n      .then((figures: { [key: string]: Partial<Figure> }) => {\n        handleFilterUpdateResponse(figures);\n      })\n      .catch(handleError);\n  };\n\n  const onFilterChanged = (filters: Partial<FilterState>) => {\n    setUpdating();\n    const newFilterState: FilterState = {\n      ...filterState,\n      ...filters,\n    };\n    setFilterState(newFilterState);\n    utilities.devLog('new filters:', newFilterState);\n    backend\n      .filterUpdate(newFilterState)\n      .then((figures: { [key: string]: Partial<Figure> }) => {\n        handleFilterUpdateResponse(figures);\n      })\n      .catch(handleError);\n  };\n\n  const onSubgroupDefine = (subgroup: Subgroup) => {\n    backend\n      .subgroupDefine(subgroup.name)\n      .then(() => {\n        setSubgroupsState([\n          ...subgroupsState.filter(\n            _subgroup => _subgroup.name !== subgroup.name,\n          ),\n          subgroup,\n        ]);\n\n\n        \n        \n\n      })\n      .catch(handleError);\n  };\n\n  const onSubgroupDelete = (name: string) => {\n    //alert('Not yet implemented in backend.');\n    backend.subgroupDelete(name).then(response =>{\n      setSubgroupsState([\n        ...subgroupsState.filter(subgroup => subgroup.name !== name),\n      ]);\n    });\n    \n  };\n  const onSubgroupActivate = (name: string) => {\n    const subgroup = subgroupsState.find(subgroup => subgroup.name === name);\n    //console.log(subgroup);\n    onFilterChanged({\n      ...filterState,\n      constraints: subgroup?.constraints,\n    });\n  };\n\n  const onControlsChanged = (\n    identifier: string,\n    controls: Partial<ControlsState>,\n  ) => {\n    setUpdating(identifier);\n    const newControls: ControlsState = {\n      ...plotControlsState[identifier].controls,\n      ...controls,\n    };\n    const newPlotControls = {\n      ...plotControlsState,\n      ...{\n        [identifier]: {\n          ...plotsState[identifier],\n          controls: newControls,\n        },\n      },\n    };\n    //console.log()\n    setPlotControlsState(newPlotControls);\n    utilities.devLog('new controls:', newControls);\n    backend\n      .controlsUpdate(newPlotControls[identifier].controls)\n      .then((figure: Partial<Figure>) => {\n        handleControlsUpdateResponse(identifier, figure);\n      })\n      .catch(handleError);\n  };\n\n  // HELPER (see first part above)\n\n  const handleError = (error: any) => {\n    console.log(error);\n    try {\n      setErrorText(`${error.toJSON().name}: ${error.toJSON().message}`);\n    } catch (e) {\n      setErrorText('ERROR: unknown');\n    }\n\n    setErrorState(true);\n    const newState: UpdatingState = {};\n      Object.keys(plotControlsState).forEach(identifier => {\n        newState[identifier] = false;\n      });\n      setUpdatingState(newState);\n  };\n\n  const handleControlsUpdateResponse = (\n    identifier: string,\n    figure: Partial<Figure>,\n  ) => {\n    setPlotsState({\n      ...plotsState,\n      [identifier]: {\n        ...plotsState[identifier],\n        data: figure.data || [],\n        layout: figure.layout || {},\n      },\n    });\n    utilities.devLog(identifier, 'done');\n    setUpdatingState({\n      ...updatingState,\n      [identifier]: false,\n    });\n  };\n\n  const handleFilterUpdateResponse = (figures: {\n    [key: string]: Partial<Figure>;\n  }) => {\n    const identifiers = Object.keys(figures);\n    const newPlotsState = { ...plotsState };\n    const newUpdatingState = { ...updatingState };\n    identifiers.forEach(identifier => {\n      newPlotsState[identifier] = {\n        data: figures[identifier].data || [],\n        layout: figures[identifier].layout || {},\n      };\n      newUpdatingState[identifier] = false;\n    });\n    setPlotsState(newPlotsState);\n    setUpdatingState(newUpdatingState);\n  };\n\n  const forceResize = () => {\n    // Workaround to trigger plot resize\n    window.dispatchEvent(new Event('resize'));\n  };\n\n  const createGridItem = (identifier: string): ReactGridLayout.Layout => {\n    return {\n      i: identifier,\n      x: (gridItemsState.length * 5) % gridResponsiveState.cols,\n      y: Infinity,\n      w: 5,\n      h: 4,\n    };\n  };\n\n  const createInitialPlotControlsState = (\n    identifier: string,\n  ): { controls: ControlsState } => {\n    return { controls: { ...initialControls, identifier } };\n  };\n\n  const setUpdating = (identifier?: string) => {\n    if (identifier) {\n      setUpdatingState({\n        ...updatingState,\n        [identifier]: true,\n      });\n    } else {\n      const newState: UpdatingState = {};\n      Object.keys(plotControlsState).forEach(identifier => {\n        newState[identifier] = true;\n      });\n      setUpdatingState(newState);\n    }\n  };\n\n  // RENDER\n\n  const createGridItemElement = (item: ReactGridLayout.Layout) => {\n    return (\n      <Card\n        key={item.i}\n        data-grid={item}\n        className={`grid__item ${\n          viewerState.activePlot === item.i ? ' grid__item--active' : ''\n        }`}\n        onClick={() => {\n          onGridItemEdit(item.i);\n        }}\n      >\n        <div className=\"grid__item-header grid--draggable\">\n          <IconButton\n            size=\"small\"\n            aria-label=\"edit\"\n            \n          >\n            <EditIcon />\n          </IconButton>\n          <IconButton\n            size=\"small\"\n            aria-label=\"close\"\n            onClick={() => {\n              onGridItemRemove(item.i);\n            }}\n            className=\"grid__item--close\"\n          >\n            <CloseIcon />\n          </IconButton>\n        </div>\n        <div className=\"grid__item-loader\">\n          {updatingState[item.i] && <LinearProgress />}\n        </div>\n        <CardContent className=\"grid__item-content\">\n          <Plot\n            identifier={item.i}\n            data={plotsState[item.i]?.data}\n            layout={plotsState[item.i]?.layout}\n            onSelected={onPlotSelected}\n          />\n        </CardContent>\n      </Card>\n    );\n  };\n  if (!(attributes && attributes.length)) return null;\n  return (\n    <div className=\"container\">\n      <div className=\"toolbar\">\n        <div className=\"toolbar__left\">\n          <Button\n            onClick={onGridItemAdd}\n            variant=\"contained\"\n            color=\"primary\"\n            startIcon={<AddIcon />}\n            title=\"Add new diagram\"\n          >\n            Add\n          </Button>\n\n          <Button\n            onClick={forceResize}\n            variant=\"contained\"\n            color=\"primary\"\n            startIcon={<AspectRatioIcon />}\n            title=\"Force resize\"\n          >\n            Resize\n          </Button>\n\n          <Button\n            onClick={onReset}\n            variant=\"contained\"\n            color=\"primary\"\n            startIcon={<ReplayIcon />}\n            title=\"Reset session\"\n          >\n            Reset session\n          </Button>\n        </div>\n\n        <div className=\"toolbar__right\">\n          <Button\n            onClick={onViewerConfigurationToggle}\n            variant=\"contained\"\n            color=\"primary\"\n            startIcon={<SettingsIcon />}\n            title=\"Toggle configuration panel\"\n          >\n            Configuration\n          </Button>\n\n          <Button\n            onClick={onViewerFilterToggle}\n            variant=\"contained\"\n            color=\"primary\"\n            startIcon={<FilterListIcon />}\n            title=\"Toggle filter panel\"\n          >\n            Filter\n          </Button>\n        </div>\n      </div>\n      <div className=\"row\">\n        {viewerState.filtersVisible && (\n          <Filter\n            filter={filterState}\n            subgroups={subgroupsState}\n            onFilterChanged={onFilterChanged}\n            onSubgroupDefine={onSubgroupDefine}\n            onSubgroupDelete={onSubgroupDelete}\n            onSubgroupActivate={onSubgroupActivate}\n            onClose={onViewerFilterToggle}\n            getTooltip = {getTooltip}\n          />\n        )}\n        <div className=\"scrollContainer\">\n        <Grid\n          breakpointCols={{ lg: 12, md: 10, sm: 6, xs: 4, xxs: 2 }}\n          rowHeight={100}\n          layouts={gridLayoutsState}\n          onBreakpointChange={onGridBreakpointChange}\n          onLayoutChange={onGridLayoutChange}\n        >\n          {gridItemsState.map((item: ReactGridLayout.Layout) =>\n            createGridItemElement(item),\n          )}\n        </Grid>\n        </div>\n        {viewerState.controlsVisible && (\n          <Configuration\n            controls={plotControlsState[viewerState.activePlot]?.controls}\n            onControlsChanged={onControlsChanged}\n            onClose={onViewerConfigurationToggle}\n            filter={filter}\n          />\n        )}\n      </div>\n\n      <Snackbar\n        open={errorState}\n        autoHideDuration={10000}\n        onClose={() => {\n          setErrorState(false);\n        }}\n        anchorOrigin={{ vertical: 'top', horizontal: 'right' }}\n      >\n        <Alert\n          variant=\"filled\"\n          severity=\"error\"\n          onClose={() => {\n            setErrorState(false);\n          }}\n        >\n          {errorText}\n        </Alert>\n      </Snackbar>\n    </div>\n  );\n};\n\nexport default Viewer;\n"]},"metadata":{},"sourceType":"module"}